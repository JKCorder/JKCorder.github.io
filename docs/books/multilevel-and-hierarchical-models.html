<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>D Multilevel and hierarchical models | Political Science and Applied Statistics using R</title>
<meta name="author" content="J.K. Corder">
<meta name="description" content="This is a short introduction to hierarchical models - drawn almost entirely from Chapter 12. “Multilevel Linear Models: The Basics” in Gelman and Hill (2006). The authors use R throughout the text...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="D Multilevel and hierarchical models | Political Science and Applied Statistics using R">
<meta property="og:type" content="book">
<meta property="og:description" content="This is a short introduction to hierarchical models - drawn almost entirely from Chapter 12. “Multilevel Linear Models: The Basics” in Gelman and Hill (2006). The authors use R throughout the text...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="D Multilevel and hierarchical models | Political Science and Applied Statistics using R">
<meta name="twitter:description" content="This is a short introduction to hierarchical models - drawn almost entirely from Chapter 12. “Multilevel Linear Models: The Basics” in Gelman and Hill (2006). The authors use R throughout the text...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.1/tabs.js"></script><script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Political Science and Applied Statistics using R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About</a></li>
<li><a class="" href="why-math-why-r.html"><span class="header-section-number">1</span> Why math? Why R?</a></li>
<li><a class="" href="regression-review-and-assumptions.html"><span class="header-section-number">2</span> Regression: review and assumptions</a></li>
<li><a class="" href="logistic-regression.html"><span class="header-section-number">3</span> Logistic regression</a></li>
<li><a class="" href="using-interaction-terms.html"><span class="header-section-number">4</span> Using interaction terms</a></li>
<li><a class="" href="working-with-time-series.html"><span class="header-section-number">5</span> Working with time series</a></li>
<li><a class="" href="dynamic-models-1.html"><span class="header-section-number">6</span> Dynamic Models</a></li>
<li><a class="" href="working-with-panel-data.html"><span class="header-section-number">7</span> Working with panel data</a></li>
<li><a class="" href="dynamics-panel-models---a-brief-introduction.html"><span class="header-section-number">8</span> Dynamics panel models - a brief introduction</a></li>
<li><a class="" href="counts.html"><span class="header-section-number">9</span> Counts</a></li>
<li><a class="" href="duration-models.html"><span class="header-section-number">10</span> Duration models</a></li>
<li><a class="" href="references.html"><span class="header-section-number">11</span> References</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="using-the-american-national-election-study.html">Using the American National Election Study</a></li>
<li><a class="" href="the-harvard-dataverse.html">The Harvard Dataverse</a></li>
<li><a class="" href="replicating-when-do-politicians-grandstand.html">Replicating “When do politicians grandstand?”</a></li>
<li><a class="" href="data-models-and-evidence-based-policymaking.html"><span class="header-section-number">A</span> Data, models and evidence-based policymaking</a></li>
<li><a class="" href="quasi--and-natural-experiments.html"><span class="header-section-number">B</span> Quasi- and natural experiments</a></li>
<li><a class="" href="matching.html"><span class="header-section-number">C</span> Matching</a></li>
<li><a class="active" href="multilevel-and-hierarchical-models.html"><span class="header-section-number">D</span> Multilevel and hierarchical models</a></li>
<li><a class="" href="about-the-author.html">About the author</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="multilevel-and-hierarchical-models" class="section level1" number="15">
<h1>
<span class="header-section-number">D</span> Multilevel and hierarchical models<a class="anchor" aria-label="anchor" href="#multilevel-and-hierarchical-models"><i class="fas fa-link"></i></a>
</h1>
<p>This is a short introduction to hierarchical models - drawn almost entirely from Chapter 12. “Multilevel Linear Models: The Basics” in <span class="citation"><a href="references.html#ref-gelmanhill" role="doc-biblioref">Gelman and Hill</a> (<a href="references.html#ref-gelmanhill" role="doc-biblioref">2006</a>)</span>. The authors use R throughout the text and make available all of the data and R code used in the book. I adapt the data manipulation and presentation of output to lean on functions from <strong>dplyr</strong>, <strong>ggplot2</strong>, and <strong>stargazer</strong>.</p>
<div id="why-is-ols-a-special-case" class="section level2" number="15.1">
<h2>
<span class="header-section-number">D.1</span> Why is OLS a special case?<a class="anchor" aria-label="anchor" href="#why-is-ols-a-special-case"><i class="fas fa-link"></i></a>
</h2>
<p>Classical regression can imply a number of assumptions: treatment effects are homogeneous (same slope coefficients) and there is no unmeasured heterogeneity (same intercepts). We have covered a couple of ways to permit these assumptions to be relaxed. We use <em>interaction terms</em> to model conditional marginal effects. In this instance, we are claiming that groups of observations may have different slopes. If we have data that are repeated measures - panel data - same units measured more than one time - then we can use <em>fixed effects</em> (least squares dummy variables). In that case, we are attempting to handle unmeasured heterogeneity by allowing intercepts to vary.</p>
</div>
<div id="why-multilevel-models" class="section level2" number="15.2">
<h2>
<span class="header-section-number">D.2</span> Why multilevel models?<a class="anchor" aria-label="anchor" href="#why-multilevel-models"><i class="fas fa-link"></i></a>
</h2>
<p>An alternative way of managing research situations where we expect or see diverse or heterogeneous responses is a <em>hierarchical</em> or <em>multilevel</em> model - two names for the same approach. The idea is that we recognize that observations are from different sources (organizations, geographic units, groups of people). We have chosen to group all of those observations in a single dataset. We might have many households from a number of different counties. We might have many counties from many states or provinces from many countries. We might have individuals at particular sites. We might have respondents to different iterations of similar surveys.</p>
<p>We understand our observations to be indexed x<sub>ij</sub> where <em>i</em> indicates the individual and <em>j</em> indicates the group. Panel data are really a specific case of this form of data, where <em>i</em> is the unit observed and <em>j</em> is the time period x<sub>it</sub>. <em>Time series cross sectional data (TSCS)</em> have this form.</p>
<p>Gelman and Hill also introduce <em>non-nested models</em> which implies multiple and perhaps overlapping groups. For example, in an individual-level dataset, people may be drawn from the same geographic area and people may be related in other ways (share the same occupation). Recall that some of our approaches to panel data required or assumed that the data were <em>strongly balanced</em> - same individuals observed in each time period with no gaps. Multilevel modeling does not impose this type of restrictions - you might have a few units in one area, many units in another area.</p>
<p>Unlike our approach to panel data in earlier classes, we do not simply rely on the knowledge that groups of observations may share different intercepts or errors. We can actually introduce information at the higher level of aggregation to model this variation. For instance, we might have information about states that less us improve predictions for something we measure at the level of counties or townships. This is why this approach is described a hierarchical - there are top-level (group level) data and lower level (individual level) data. Multilevel models imply two or more models estimated simultaneously - a regression for the coefficients modeled at the lowest level and a regression model for the intercept or differences in coefficients at the level of groups. This is a powerful generalization of the classical linear model.</p>
<p>When we introduced the panel data estimators, we considered how we could estimate a regression by simply pooling all of the data together, ignoring any unmeasured heterogeneity and ignoring problems of heteroscedasticity (this is designated as <em>complete pooling</em>). An alternative strategy might be to simply estimate model parameters separately for each group of observations (<em>no pooling</em>): this creates a problem of low numbers of observations and low power. Gelman and Hill describe the multilevel model as a compromise between complete pooling (ignoring a categorical grouping variable like country) and no pooling (estimating different models for each category or country).</p>
<p>One area where multilevel models are commonly used is to study education outcomes. The dataset might consist of student performance outcomes and student characteristics, but we also know the school and the county or city the student is observed. We may be interested in the size of the school or the percentage of free/reduced lunches. We may be interested in the demographics of the city or county. We know that student characteristics interact with these environmental features to influence performance.</p>
<p>If you collect data of this form, you should consider and use a multilevel approach.</p>
</div>
<div id="a-sample-dataset-and-problem" class="section level2" number="15.3">
<h2>
<span class="header-section-number">D.3</span> A sample dataset and problem<a class="anchor" aria-label="anchor" href="#a-sample-dataset-and-problem"><i class="fas fa-link"></i></a>
</h2>
<p>Gelman and Hill use a dataset of radon measurements to motivate discussion of the multilevel approach. The dataset contains information about radon levels in thousands of homes located in hundreds of U.S. counties.</p>
<p>Radon is a naturally occurring gas that is a by-product of the decay of uranium. Homes near uranium deposits may accumulate dangerous levels of radon gas; exposure to this gas has been linked to lung cancer. We will use four pieces of information from the dataset: the measured radon level, whether the sample was taken in the basement or on the first floor, what county the home is in, and the measurement of soil uranium in that county. The idea is that we use information from the aggregate (the county) to improve predictions at lower levels of aggregation (the homes). The data and all of the R code for the figures and models are adapted or directly from the companion website for the book. These examples are drawn from Chapter 12.</p>
<p>The R package <strong>lme4</strong> permits us to estimate basic hierarchical models. The particular function that we will use is <code>lmer</code>, a maximum likelihood estimator.</p>
<p>I estimate and interpret a series of progressively more complicated models using data from the 85 counties in the dataset from the state of Minnesota. We use information about each county and each household to understand the likely value of a radon test in a home in a particular county. Since radon levels are higher in basements, it is important to use this information in the model, especially if data from some counties is primarily taken from basement measurements while others are taken on the first floor.</p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Set up the radon data</span>
<span class="co"># Read, subset and tranform the data</span>
<span class="va">srrs2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span> <span class="op">(</span><span class="st">"http://www.stat.columbia.edu/~gelman/arm/examples/radon/srrs2.dat"</span>, header<span class="op">=</span><span class="cn">T</span>, sep<span class="op">=</span><span class="st">","</span><span class="op">)</span>
<span class="va">mn</span> <span class="op">&lt;-</span> <span class="va">srrs2</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"MN"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>log.activity<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span> <span class="op">(</span><span class="va">activity</span><span class="op">==</span><span class="fl">0</span>, <span class="fl">.1</span>, <span class="va">activity</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Get the county-level predictor</span>
<span class="va">cty</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span> <span class="op">(</span><span class="st">"http://www.stat.columbia.edu/~gelman/arm/examples/radon/cty.dat"</span>, header<span class="op">=</span><span class="cn">T</span>, sep<span class="op">=</span><span class="st">","</span><span class="op">)</span>
<span class="va">cty2</span> <span class="op">&lt;-</span> <span class="va">cty</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">st</span><span class="op">==</span><span class="st">"MN"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>u<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Uppm</span><span class="op">)</span>, cntyfips<span class="op">=</span><span class="va">ctfips</span><span class="op">)</span>

<span class="co"># There are two duplicate counties, which need to be deleted before joining - other wise model 5 has problems</span>
<span class="va">cty2</span> <span class="op">&lt;-</span> <span class="va">cty2</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">11</span>, <span class="fl">39</span><span class="op">)</span><span class="op">)</span>


<span class="co"># This creates the data frame with all variables available</span>
<span class="va">data</span><span class="op">&lt;-</span><span class="fu">left_join</span><span class="op">(</span><span class="va">mn</span>, <span class="va">cty2</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cntyfips"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># This step just strips out the uranium by county, used below</span>
<span class="va">u_county</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">county</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>u<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="data-and-figures" class="section level3" number="15.3.1">
<h3>
<span class="header-section-number">D.3.1</span> Data and figures<a class="anchor" aria-label="anchor" href="#data-and-figures"><i class="fas fa-link"></i></a>
</h3>
<p>The actual distribution of radon activity reported in the national survey is fairly close to zero is most households. The metric for the measure is picocuries per liter of air, or pCi/L. According the EPA’s <strong>A Citizen Guide to Radon</strong>, the typical level of radon in outside air is 0.4 pCi/L and the average home indoor level is 1.7. The measured radon levels in the 919 sample homes are summarized in the figure below. The threshold for remediation is 4.0.</p>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Plot the histogram</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">mn</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">activity</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">2</span>, colour <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Measured levels of radon"</span>, y<span class="op">=</span><span class="st">"Frequency"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="15-multilevel_files/figure-html/figure1-1.png" width="672"></div>
<p>Since radon effects are cumulative, the researchers use the log of the measure as a measure of risk. The overall distribution of the dependent variable, the log of measured radon activity, is displayed below:</p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Plot the log</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">mn</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">log.activity</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.25</span>, colour <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Log level of radon"</span>, y<span class="op">=</span><span class="st">"Frequency"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="15-multilevel_files/figure-html/figure2-1.png" width="672"></div>
</div>
<div id="model-1-complete-pooling-one-predictor" class="section level3" number="15.3.2">
<h3>
<span class="header-section-number">D.3.2</span> Model 1 (complete pooling, one predictor)<a class="anchor" aria-label="anchor" href="#model-1-complete-pooling-one-predictor"><i class="fas fa-link"></i></a>
</h3>
<p>This model uses logged radon measurement as the dependent variable and the location of the test (first floor or basement as the predictor). We ignore the information that multiple households are from one county. This is just a basic regression. All of the counties share the same intercept and the same value of the estimated slope coefficient.</p>
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lm.pooled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span> <span class="op">(</span><span class="va">log.activity</span> <span class="op">~</span> <span class="va">floor</span>, data<span class="op">=</span><span class="va">mn</span><span class="op">)</span>
<span class="fu">stargazer</span> <span class="op">(</span><span class="va">lm.pooled</span>, style<span class="op">=</span><span class="st">"apsr"</span>, type<span class="op">=</span><span class="st">"html"</span> , omit<span class="op">=</span><span class="st">"factor"</span> , dep.var.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Log of radon measure"</span>, <span class="st">"\n"</span><span class="op">)</span>, digits<span class="op">=</span><span class="fl">3</span>, covariate.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"First floor reading"</span><span class="op">)</span>, omit.stat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LL"</span>,<span class="st">"ser"</span>,<span class="st">"f"</span><span class="op">)</span>,column.sep.width<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"12pt"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table style="text-align:center" class="table table-sm">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
Log of radon measure
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
First floor reading
</td>
<td>
-0.613<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.073)
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
1.327<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.030)
</td>
</tr>
<tr>
<td style="text-align:left">
N
</td>
<td>
919
</td>
</tr>
<tr>
<td style="text-align:left">
R<sup>2</sup>
</td>
<td>
0.072
</td>
</tr>
<tr>
<td style="text-align:left">
Adjusted R<sup>2</sup>
</td>
<td>
0.071
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td colspan="2" style="text-align:left">
<sup><em></em></sup>p &lt; .1; <sup><strong></strong></sup>p &lt; .05; <sup></sup>p &lt; .01
</td>
</tr>
</table></div>
<p><br></p>
<p>The table tells us that the average predicted reading for any household in any county would be 1.33 for a basement measurement and 0.713 for a first floor measurement. This would be our best guess for a radon measurement from any house in the sample, depending on where the measure was taken.</p>
</div>
<div id="model-2-no-pooling-one-household-predictor-county-level-fixed-effects" class="section level3" number="15.3.3">
<h3>
<span class="header-section-number">D.3.3</span> Model 2 (no pooling, one household predictor, county-level fixed effects)<a class="anchor" aria-label="anchor" href="#model-2-no-pooling-one-household-predictor-county-level-fixed-effects"><i class="fas fa-link"></i></a>
</h3>
<p>We estimate the model with standard OLS with fixed effects for each county. This is the approach we used with panel data, a dummy variable for each household. The ” -1 ” after <code><a href="https://rdrr.io/r/base/factor.html">factor(county)</a></code> indicates no intercept, so I can have a dummy for every county. Adding the county-level dummy permits otherwise unmeasured county-level differences to improve the prediction. The model does include 85 dummy variables - one for each county - but I suppressed that output (using the <code>omit</code> option in the stargazer command).</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lm.unpooled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span> <span class="op">(</span><span class="va">log.activity</span> <span class="op">~</span> <span class="va">floor</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">county</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">mn</span><span class="op">)</span>
<span class="fu">stargazer</span> <span class="op">(</span><span class="va">lm.unpooled</span>, style<span class="op">=</span><span class="st">"apsr"</span>, type<span class="op">=</span><span class="st">"html"</span> , omit<span class="op">=</span><span class="st">"factor"</span> , dep.var.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Log of radon measure"</span>, <span class="st">"\n"</span><span class="op">)</span>, digits<span class="op">=</span><span class="fl">2</span>, covariate.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"First floor reading"</span><span class="op">)</span>, omit.stat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LL"</span>,<span class="st">"ser"</span>,<span class="st">"f"</span><span class="op">)</span>,column.sep.width<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"12pt"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table style="text-align:center" class="table table-sm">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
Log of radon measure
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
First floor reading
</td>
<td>
-0.72<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.07)
</td>
</tr>
<tr>
<td style="text-align:left">
N
</td>
<td>
919
</td>
</tr>
<tr>
<td style="text-align:left">
R<sup>2</sup>
</td>
<td>
0.77
</td>
</tr>
<tr>
<td style="text-align:left">
Adjusted R<sup>2</sup>
</td>
<td>
0.74
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td colspan="2" style="text-align:left">
<sup><em></em></sup>p &lt; .1; <sup><strong></strong></sup>p &lt; .05; <sup></sup>p &lt; .01
</td>
</tr>
</table></div>
<p><br></p>
<p>Notice the jump in the R-squared.</p>
<p>The figure below shows the intercept and standard errors associated with each intercept as a function of the number of households sampled in each county. One thing that jumps out is that extremely high intercepts (positive readings) are associated with counties that have only 1 or 2 households in the sample. Our estimate for these counties is probably too high and our overall assessment of county-level variation is too high since we have small samples with large standard errors in these counties.</p>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># tidy the data and retain the 85 dummy coefficients and standard errors</span>
<span class="va">results</span><span class="op">&lt;-</span><span class="fu">tidy</span><span class="op">(</span><span class="va">lm.unpooled</span><span class="op">)</span>
<span class="va">results</span><span class="op">&lt;-</span> <span class="va">results</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span><span class="op">!=</span><span class="st">"floor"</span><span class="op">)</span>

<span class="co">## get a table of sample size in each county</span>
<span class="va">sample.size</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">mn</span><span class="op">$</span><span class="va">county</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Be cautious with this command - doesn't really join just mashes the dataframes</span>
<span class="co"># A careful approach would strip out county names and use join</span>
<span class="va">results</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="va">sample.size</span><span class="op">)</span>

<span class="co"># Reproduce the figure with horizontal jitter</span>
<span class="fu">ggplot</span><span class="op">(</span>data<span class="op">=</span><span class="va">results</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">Freq</span>, y<span class="op">=</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span>position <span class="op">=</span> <span class="fu">position_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.10</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3.5</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_linerange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Freq</span>, ymin <span class="op">=</span> <span class="va">estimate</span><span class="op">+</span><span class="va">std.error</span>, ymax <span class="op">=</span> <span class="va">estimate</span><span class="op">-</span><span class="va">std.error</span><span class="op">)</span>,
                   lwd <span class="op">=</span> <span class="fl">0.5</span>, position <span class="op">=</span> <span class="fu">position_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.10</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Sample size in county"</span>, y<span class="op">=</span><span class="st">"Estimated intercept"</span>, caption<span class="op">=</span><span class="st">"Figure 3. Estimates +/- standard errors for the county intercepts, no pooling"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure">
<img src="15-multilevel_files/figure-html/figure12_3a-1.png" width="672">
(This replicates Figure 12.3)</div>
</div>
<div id="model-3-partial-pooling-one-household-predictor-multilevel-model" class="section level3" number="15.3.4">
<h3>
<span class="header-section-number">D.3.4</span> Model 3 (partial pooling, one household predictor, multilevel model)<a class="anchor" aria-label="anchor" href="#model-3-partial-pooling-one-household-predictor-multilevel-model"><i class="fas fa-link"></i></a>
</h3>
<p>This is a multilevel model that permits the intercept to vary about a shared mean. We know the shared mean (1.33) from Model 1 and the individual fixed effects from Model 2. This model is a combination of that information. Note that different information is reported when we invoke (<code>lmer</code>, rather than <code>lm</code>). We have goodness of fit test statistics and the deviance reported below, rather than R-squared. This is one indicator we are estimating via maximum likelihood.</p>
<p>The `(1 | county)’ notation in the lmer function indicates unique intercepts for each county.</p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This corresponds to M1 at page 259 of Gelman and Hill</span>
<span class="va">model3</span> <span class="op">&lt;-</span> <span class="fu">lmer</span> <span class="op">(</span>formula <span class="op">=</span> <span class="va">log.activity</span> <span class="op">~</span> <span class="va">floor</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>, data<span class="op">=</span><span class="va">mn</span><span class="op">)</span>
<span class="fu">stargazer</span> <span class="op">(</span><span class="va">model3</span>, type<span class="op">=</span><span class="st">"html"</span> , style<span class="op">=</span><span class="st">"apsr"</span>, omit<span class="op">=</span><span class="st">"factor"</span> , dep.var.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Log of radon measure"</span>, <span class="st">"\n"</span><span class="op">)</span>, covariate.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"First floor reading"</span><span class="op">)</span>, digits<span class="op">=</span><span class="fl">2</span>, omit.stat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LL"</span>,<span class="st">"ser"</span>,<span class="st">"f"</span><span class="op">)</span>, title<span class="op">=</span><span class="st">"**Table 3. Household radon, partial pooling, multilevel model**"</span>,
          notes<span class="op">=</span> <span class="st">"p&lt;.01*** ; p&lt;.05**"</span>,  notes.append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table style="text-align:center" class="table table-sm">
<caption>
<strong><strong>Table 3. Household radon, partial pooling, multilevel model</strong></strong>
</caption>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
Log of radon measure
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
First floor reading
</td>
<td>
-0.69<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.07)
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
1.46<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.05)
</td>
</tr>
<tr>
<td style="text-align:left">
N
</td>
<td>
919
</td>
</tr>
<tr>
<td style="text-align:left">
AIC
</td>
<td>
2,179.31
</td>
</tr>
<tr>
<td style="text-align:left">
BIC
</td>
<td>
2,198.60
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td colspan="2" style="text-align:left">
p&lt;.01*** ; p&lt;.05**
</td>
</tr>
</table></div>
<p><br></p>
<p>The figure below shows the estimated intercept for each county with standard errors attached.</p>
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># tidy won't work lmer</span>
<span class="va">a.hat.model3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span><span class="op">$</span><span class="va">county</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>   
<span class="va">a.se.model3</span> <span class="op">&lt;-</span> <span class="fu">se.coef</span><span class="op">(</span><span class="va">model3</span><span class="op">)</span><span class="op">$</span><span class="va">county</span>
<span class="va">results</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">a.hat.model3</span>, <span class="va">a.se.model3</span><span class="op">)</span><span class="op">)</span>
<span class="va">results</span><span class="op">&lt;-</span><span class="va">std.err</span><span class="op">&lt;-</span><span class="va">results</span><span class="op">$</span><span class="va">`(Intercept)`</span>
<span class="co">## get a table of sample size in each county</span>
<span class="va">sample.size</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">mn</span><span class="op">$</span><span class="va">county</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Be cautious with this command - doesn't really join just mashes the dataframes</span>
<span class="co"># A careful approach would strip out county names and use join</span>
<span class="va">results</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">results</span>, <span class="va">sample.size</span><span class="op">)</span>

<span class="co"># Reproduce the figure with horizontal jitter</span>
<span class="fu">ggplot</span><span class="op">(</span>data<span class="op">=</span><span class="va">results</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">Freq</span>, y<span class="op">=</span><span class="va">a.hat.model3</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span>position <span class="op">=</span> <span class="fu">position_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.10</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_linerange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Freq</span>, ymin <span class="op">=</span> <span class="va">a.hat.model3</span><span class="op">+</span><span class="va">std.err</span>, ymax <span class="op">=</span> <span class="va">a.hat.model3</span><span class="op">-</span><span class="va">std.err</span><span class="op">)</span>,
                   lwd <span class="op">=</span> <span class="fl">0.5</span>, position <span class="op">=</span> <span class="fu">position_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.10</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Sample size in county"</span>, y<span class="op">=</span><span class="st">"Estimated intercept"</span>, caption<span class="op">=</span><span class="st">"Figure 4. Estimates +/- standard errors for the county intercepts, multilevel model"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure">
<img src="15-multilevel_files/figure-html/figure12_3b-1.png" width="672">
(Reproduces Figure 12.3(b))</div>
<p>The idea is that we leverage the information about the state mean and counties with very few observations are drawn closer to this state mean. Counties with large numbers of households are not affected. Gelman and Hill note that both of Model 1 and Model 2 can be problematic: we might overstate county-level variation based on small samples in Model 2 or we might understate county-level variation if ignore too much information in counties with extreme variation from the mean in Model 1. Model 3 is a compromise.</p>
</div>
<div id="model-4-pooled-data-one-household-predictor-one-county-level-predictor-multilevel-model." class="section level3" number="15.3.5">
<h3>
<span class="header-section-number">D.3.5</span> Model 4 (pooled data, one household predictor, one county-level predictor, multilevel model).<a class="anchor" aria-label="anchor" href="#model-4-pooled-data-one-household-predictor-one-county-level-predictor-multilevel-model."><i class="fas fa-link"></i></a>
</h3>
<p>The real advantage of multilevel modelling is that we can directly introduce information from the higher levels of aggregation levels to the equation. Remember when we used fixed effects for our panel data, we could not introduce time invariant country features since they dropped out? In this modelling framework you do use features of the grouping variable (county in this case) that do not vary across households within the county. The variable we are introducing is soil uranium. County-level uranium soil levels are introduced as a predictor. The assumption here is that the coefficients on basement/floor and soil uranium will be the same for all households in all counties. But the level of uranium in the soil in the county will improve our estimate for the intercept, the remaining unmeasured heterogeneity.</p>
<p>Notice that the goodness of fit test statistics are all lower - this indicates better model performance.</p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This corresponds to M2 in Gelman and Hill page 266</span>
<span class="va">model4</span> <span class="op">&lt;-</span> <span class="fu">lmer</span> <span class="op">(</span>formula <span class="op">=</span> <span class="va">log.activity</span> <span class="op">~</span> <span class="va">floor</span> <span class="op">+</span> <span class="va">u</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>, data<span class="op">=</span><span class="va">data</span><span class="op">)</span>
<span class="fu">stargazer</span> <span class="op">(</span><span class="va">model4</span>, type<span class="op">=</span><span class="st">"html"</span> ,style<span class="op">=</span><span class="st">"apsr"</span>,  omit<span class="op">=</span><span class="st">"factor"</span> ,  dep.var.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Log of radon measure"</span>, <span class="st">"\n"</span><span class="op">)</span>, covariate.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"First floor reading"</span>, <span class="st">"Soil uranium"</span><span class="op">)</span>, digits<span class="op">=</span><span class="fl">2</span>, omit.stat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LL"</span>,<span class="st">"ser"</span>,<span class="st">"f"</span><span class="op">)</span>,column.sep.width<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"12pt"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table style="text-align:center" class="table table-sm">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
Log of radon measure
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
First floor reading
</td>
<td>
-0.67<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.07)
</td>
</tr>
<tr>
<td style="text-align:left">
Soil uranium
</td>
<td>
0.72<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.09)
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
1.47<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.04)
</td>
</tr>
<tr>
<td style="text-align:left">
N
</td>
<td>
919
</td>
</tr>
<tr>
<td style="text-align:left">
AIC
</td>
<td>
2,144.19
</td>
</tr>
<tr>
<td style="text-align:left">
BIC
</td>
<td>
2,168.30
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td colspan="2" style="text-align:left">
<sup><em></em></sup>p &lt; .1; <sup><strong></strong></sup>p &lt; .05; <sup></sup>p &lt; .01
</td>
</tr>
</table></div>
<p><br></p>
<p>The figure below plots the intercept in the counties as a function of measured soil uranium. I kepy the y-axis on the same scale as Figure 4, so you can clearly see how the standard errors are much smaller when we introduced the group=level predictor</p>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Plot of ests &amp; se's vs. county uranium (Figure 12.6)</span>
<span class="co"># Pick up the standard errors and coefficients</span>
<span class="co"># Write as new columns in the results file created above</span>
<span class="va">results</span><span class="op">$</span><span class="va">std.err.model4</span> <span class="op">&lt;-</span> <span class="fu">se.coef</span><span class="op">(</span><span class="va">model4</span><span class="op">)</span><span class="op">$</span><span class="va">county</span>
<span class="va">a.hat.model4</span> <span class="op">&lt;-</span> <span class="fu">fixef</span><span class="op">(</span><span class="va">model4</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu">fixef</span><span class="op">(</span><span class="va">model4</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">*</span><span class="va">u_county</span><span class="op">$</span><span class="va">u</span> <span class="op">+</span> <span class="fu">ranef</span><span class="op">(</span><span class="va">model4</span><span class="op">)</span><span class="op">$</span><span class="va">county</span>
<span class="va">results</span><span class="op">$</span><span class="va">a.hat.model4</span><span class="op">&lt;-</span><span class="va">a.hat.model4</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
<span class="va">results</span><span class="op">$</span><span class="va">b.hat.model4</span> <span class="op">&lt;-</span> <span class="fu">fixef</span><span class="op">(</span><span class="va">model4</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="va">results</span><span class="op">$</span><span class="va">u</span><span class="op">&lt;-</span><span class="va">u_county</span><span class="op">$</span><span class="va">u</span>
<span class="co"># Need vector of u to pass to results (n=85 only)</span>

<span class="co"># Produce the figure</span>
<span class="co"># Reproduce the figure with horizontal jitter</span>
<span class="fu">ggplot</span><span class="op">(</span>data<span class="op">=</span><span class="va">results</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">u</span>, y<span class="op">=</span><span class="va">a.hat.model4</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span>position <span class="op">=</span> <span class="fu">position_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.10</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_smooth</span><span class="op">(</span>method<span class="op">=</span><span class="st">"lm"</span>, se<span class="op">=</span> <span class="cn">FALSE</span>, formula <span class="op">=</span> <span class="va">y</span><span class="op">~</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span>
 <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"County-level uranium measure"</span>, y<span class="op">=</span><span class="st">"Estimated intercept"</span>, caption<span class="op">=</span><span class="st">"Figure 5. Estimates +/- standard errors for the county intercepts, multilevel model, one group predictor"</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">geom_linerange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">u</span>, ymin <span class="op">=</span> <span class="va">a.hat.model4</span><span class="op">+</span><span class="va">std.err.model4</span>, ymax <span class="op">=</span> <span class="va">a.hat.model4</span><span class="op">-</span><span class="va">std.err.model4</span><span class="op">)</span>,
                   lwd <span class="op">=</span> <span class="fl">0.5</span>, position <span class="op">=</span> <span class="fu">position_jitter</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.10</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure">
<img src="15-multilevel_files/figure-html/figure126-1.png" width="672">
(Reproduces Figure 12.6)</div>
<p>As county level uranium increases, our estimate of the intercept increases and the remaining county-level error is much lower.</p>
</div>
<div id="model-5.-permit-intercepts-and-coefficients-to-vary.-no-restrictions." class="section level3" number="15.3.6">
<h3>
<span class="header-section-number">D.3.6</span> Model 5. Permit intercepts and coefficients to vary. No restrictions.<a class="anchor" aria-label="anchor" href="#model-5.-permit-intercepts-and-coefficients-to-vary.-no-restrictions."><i class="fas fa-link"></i></a>
</h3>
<p>This is the least restrictive model. <code>x:ufull</code> is the interaction term (permitting slopes to vary), and <code>(1 | county)</code> indicates that the intercept can vary across counties independent of the soil measure. There is an error messgae or warning “boundary (singular) fit:” - this suggests we are <em>over-fitting</em> the model, estimating too many parameters with too little data.</p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This corresponds to M4 in Gelman and Hill, p. 281</span>
<span class="va">model5</span> <span class="op">&lt;-</span>  <span class="fu">lmer</span> <span class="op">(</span>formula <span class="op">=</span> <span class="va">log.activity</span> <span class="op">~</span> <span class="va">floor</span> <span class="op">+</span> <span class="op">+</span><span class="va">u</span> <span class="op">+</span> <span class="va">floor</span><span class="op">:</span><span class="va">u</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">floor</span> <span class="op">|</span> <span class="va">county</span><span class="op">)</span>, data<span class="op">=</span><span class="va">data</span><span class="op">)</span>

<span class="fu">stargazer</span> <span class="op">(</span><span class="va">model5</span>, type<span class="op">=</span><span class="st">"html"</span> , style<span class="op">=</span><span class="st">"apsr"</span>, omit<span class="op">=</span><span class="st">"factor"</span> , dep.var.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Log of radon measure"</span>, <span class="st">"\n"</span><span class="op">)</span>, digits<span class="op">=</span><span class="fl">2</span>, covariate.labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"First floor reading"</span>, <span class="st">"Soil uranium"</span>, <span class="st">"Interaction term"</span><span class="op">)</span>, omit.stat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LL"</span>,<span class="st">"ser"</span>,<span class="st">"f"</span><span class="op">)</span>,column.sep.width<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"12pt"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table style="text-align:center" class="table table-sm">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
Log of radon measure
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
First floor reading
</td>
<td>
-0.64<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.09)
</td>
</tr>
<tr>
<td style="text-align:left">
Soil uranium
</td>
<td>
0.85<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.07)
</td>
</tr>
<tr>
<td style="text-align:left">
Interaction term
</td>
<td>
-0.42<sup>*</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.24)
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
1.44<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.03)
</td>
</tr>
<tr>
<td style="text-align:left">
N
</td>
<td>
919
</td>
</tr>
<tr>
<td style="text-align:left">
AIC
</td>
<td>
2,148.24
</td>
</tr>
<tr>
<td style="text-align:left">
BIC
</td>
<td>
2,186.82
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td colspan="2" style="text-align:left">
<sup><em></em></sup>p &lt; .1; <sup><strong></strong></sup>p &lt; .05; <sup></sup>p &lt; .01
</td>
</tr>
</table></div>
<p><br></p>
<p>The figures below show how the slopes and the intercepts vary. Notice, again, how the standard errors around the intercepts are smaller. And notice that the slopes decline (more negative) as uranium in the soil increases. This means that the difference between first floor and basement is larger in those counties.</p>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">a.hat.model5</span> <span class="op">&lt;-</span> <span class="fu">fixef</span><span class="op">(</span><span class="va">model5</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu">fixef</span><span class="op">(</span><span class="va">model5</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">*</span><span class="va">u_county</span><span class="op">$</span><span class="va">u</span> <span class="op">+</span> <span class="fu">ranef</span><span class="op">(</span><span class="va">model5</span><span class="op">)</span><span class="op">$</span><span class="va">county</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
<span class="va">b.hat.model5</span> <span class="op">&lt;-</span> <span class="fu">fixef</span><span class="op">(</span><span class="va">model5</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu">fixef</span><span class="op">(</span><span class="va">model5</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">*</span><span class="va">u_county</span><span class="op">$</span><span class="va">u</span> <span class="op">+</span> <span class="fu">ranef</span><span class="op">(</span><span class="va">model5</span><span class="op">)</span><span class="op">$</span><span class="va">county</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>
<span class="va">a.se.model5</span> <span class="op">&lt;-</span> <span class="fu">se.ranef</span><span class="op">(</span><span class="va">model5</span><span class="op">)</span><span class="op">$</span><span class="va">county</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
<span class="va">b.se.model5</span> <span class="op">&lt;-</span> <span class="fu">se.ranef</span><span class="op">(</span><span class="va">model5</span><span class="op">)</span><span class="op">$</span><span class="va">county</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>


<span class="co"># par (mfrow=c(1,1))</span>
<span class="co"># </span>
<span class="co">#  # plot on Figure 13.2(a)</span>
<span class="co"># lower &lt;- a.hat.model5 - a.se.model5</span>
<span class="co"># upper &lt;- a.hat.model5 + a.se.model5</span>
<span class="co"># par (mar=c(5,5,4,2)+.1)</span>
<span class="co"># plot (u, a.hat.model5, cex.lab=1.2, cex.axis=1.1, ylim=range(lower,upper), </span>
<span class="co">#       xlab="county-level uranium measure", ylab="regression intercept", </span>
<span class="co">#       pch=20, yaxt="n")</span>
<span class="co"># axis (2, c(0,1,1.5,2))</span>
<span class="co"># curve (fixef(model5)[1] + fixef(model5)[3]*x, lwd=1, col="black", add=TRUE)</span>
<span class="co"># segments (u, lower, u, upper, lwd=.5, col="gray10")</span>
<span class="co"># mtext ("Intercepts", line=1)</span>
<span class="co"># </span>
<span class="co">#  # plot on Figure 13.2(b)</span>
<span class="co"># lower &lt;- b.hat.model5 - b.se.model5</span>
<span class="co"># upper &lt;- b.hat.model5 + b.se.model5</span>
<span class="co"># par (mar=c(5,5,4,2)+.1)</span>
<span class="co"># plot (u, b.hat.model5, cex.lab=1.2, cex.axis=1.1, ylim=range(lower,upper),</span>
<span class="co">#       xlab="county-level uranium measure", ylab="regression slope", pch=20)</span>
<span class="co"># curve (fixef(model5)[2] + fixef(model5)[4]*x, lwd=1, col="black", add=TRUE)</span>
<span class="co"># segments (u, lower, u, upper, lwd=.5, col="gray10")</span>
<span class="co"># mtext ("Slopes", line=1)</span></code></pre></div>
</div>
</div>
<div id="summary" class="section level2" number="15.4">
<h2>
<span class="header-section-number">D.4</span> Summary<a class="anchor" aria-label="anchor" href="#summary"><i class="fas fa-link"></i></a>
</h2>
<p>Multilevel models are extremely useful for research situations where we have data collected across varying geographic or organizational contexts, but where we expect common mechanisms linking X and Y and we expect the form of these links to be variable or dependent on the context.</p>
</div>
<div id="next-week-2" class="section level2" number="15.5">
<h2>
<span class="header-section-number">D.5</span> Next week<a class="anchor" aria-label="anchor" href="#next-week-2"><i class="fas fa-link"></i></a>
</h2>
<p>Review the replication example in the Appendix, reproducing key results from <span class="citation"><a href="references.html#ref-park2021" role="doc-biblioref">Park</a> (<a href="references.html#ref-park2021" role="doc-biblioref">2021</a>)</span></p>
<p>We will use the multilevel model as a bridge to learn about Bayesian methods.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="matching.html"><span class="header-section-number">C</span> Matching</a></div>
<div class="next"><a href="about-the-author.html">About the author</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#multilevel-and-hierarchical-models"><span class="header-section-number">D</span> Multilevel and hierarchical models</a></li>
<li><a class="nav-link" href="#why-is-ols-a-special-case"><span class="header-section-number">D.1</span> Why is OLS a special case?</a></li>
<li><a class="nav-link" href="#why-multilevel-models"><span class="header-section-number">D.2</span> Why multilevel models?</a></li>
<li>
<a class="nav-link" href="#a-sample-dataset-and-problem"><span class="header-section-number">D.3</span> A sample dataset and problem</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#data-and-figures"><span class="header-section-number">D.3.1</span> Data and figures</a></li>
<li><a class="nav-link" href="#model-1-complete-pooling-one-predictor"><span class="header-section-number">D.3.2</span> Model 1 (complete pooling, one predictor)</a></li>
<li><a class="nav-link" href="#model-2-no-pooling-one-household-predictor-county-level-fixed-effects"><span class="header-section-number">D.3.3</span> Model 2 (no pooling, one household predictor, county-level fixed effects)</a></li>
<li><a class="nav-link" href="#model-3-partial-pooling-one-household-predictor-multilevel-model"><span class="header-section-number">D.3.4</span> Model 3 (partial pooling, one household predictor, multilevel model)</a></li>
<li><a class="nav-link" href="#model-4-pooled-data-one-household-predictor-one-county-level-predictor-multilevel-model."><span class="header-section-number">D.3.5</span> Model 4 (pooled data, one household predictor, one county-level predictor, multilevel model).</a></li>
<li><a class="nav-link" href="#model-5.-permit-intercepts-and-coefficients-to-vary.-no-restrictions."><span class="header-section-number">D.3.6</span> Model 5. Permit intercepts and coefficients to vary. No restrictions.</a></li>
</ul>
</li>
<li><a class="nav-link" href="#summary"><span class="header-section-number">D.4</span> Summary</a></li>
<li><a class="nav-link" href="#next-week-2"><span class="header-section-number">D.5</span> Next week</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Political Science and Applied Statistics using R</strong>" was written by J.K. Corder. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
